<!-- Response Modal -->
<div 
    id="responseModal" 
    class="response-modal" 
    role="dialog" 
    aria-modal="true" 
    aria-labelledby="responseTitle"
    aria-describedby="responseDescription"
>
    <div class="modal-overlay" onclick="TryOutSidebar.closeResponseModal()"></div>
    <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
            <div class="header-content">
                <h3 id="responseTitle">API Response</h3>
                <span id="responseDescription" class="visually-hidden">Displays the API response details and content</span>
                <div class="header-actions">
                    <button 
                        class="action-btn" 
                        onclick="copyResponse()" 
                        aria-label="Copy response"
                        data-tooltip="Copy to clipboard"
                    >
                        <span class="icon">ðŸ“‹</span>
                    </button>
                    <button 
                        class="action-btn" 
                        onclick="downloadResponse()" 
                        aria-label="Download response"
                        data-tooltip="Download as JSON"
                    >
                        <span class="icon">ðŸ’¾</span>
                    </button>
                    <button 
                        class="modal-close" 
                        aria-label="Close response modal" 
                        onclick="TryOutSidebar.closeResponseModal()"
                    >
                        <span class="icon">âœ•</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Response Stats -->
        <div class="response-stats">
            <div class="stat-group">
                <div class="stat-item">
                    <span class="stat-label">Status</span>
                    <span class="status-badge" id="modalStatusBadge"></span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Time</span>
                    <span class="stat-value" id="responseTime">0 ms</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Size</span>
                    <span class="stat-value" id="responseSize">0 KB</span>
                </div>
            </div>
            <div class="response-info" id="responseInfo"></div>
        </div>

        <!-- Response Content -->
        <div class="modal-body">
            <!-- Response Tabs -->
            <div class="response-tabs" role="tablist">
                <button 
                    class="tab active" 
                    role="tab" 
                    aria-selected="true"
                    aria-controls="responseBody"
                    data-tab="body"
                >
                    <span class="icon">ðŸ“„</span>
                    Response
                </button>
                <button 
                    class="tab" 
                    role="tab"
                    aria-selected="false"
                    aria-controls="responseHeaders"
                    data-tab="headers"
                >
                    <span class="icon">ðŸ“‹</span>
                    Headers
                </button>
                <button 
                    class="tab" 
                    role="tab"
                    aria-selected="false"
                    aria-controls="requestDetails"
                    data-tab="request"
                >
                    <span class="icon">ðŸ“¤</span>
                    Request
                </button>
            </div>

            <!-- Response Body Tab -->
            <div 
                id="responseBody" 
                class="tab-content active" 
                role="tabpanel"
            >
                <div class="response-toolbar">
                    <div class="toolbar-group">
                        <button 
                            class="tool-btn" 
                            onclick="formatResponse()"
                            data-tooltip="Format JSON"
                        >
                            <span class="icon">ðŸ”§</span>
                        </button>
                        <button 
                            class="tool-btn" 
                            onclick="collapseAll()"
                            data-tooltip="Collapse all"
                        >
                            <span class="icon">ðŸ“¦</span>
                        </button>
                        <button 
                            class="tool-btn" 
                            onclick="expandAll()"
                            data-tooltip="Expand all"
                        >
                            <span class="icon">ðŸ“‚</span>
                        </button>
                    </div>
                </div>
                <div class="response-viewer" role="region" aria-live="polite">
                    <div class="response-content" id="modalResponseBody" tabindex="0"></div>
                </div>
            </div>

            <!-- Response Headers Tab -->
            <div 
                id="responseHeaders" 
                class="tab-content" 
                role="tabpanel"
            >
                <div class="headers-list" id="responseHeadersList"></div>
            </div>

            <!-- Request Details Tab -->
            <div 
                id="requestDetails" 
                class="tab-content" 
                role="tabpanel"
            >
                <div class="request-details" id="requestDetailsList"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const tabs = document.querySelectorAll('.response-tabs .tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab));
    });

    // Initialize syntax highlighting
    initializePrism();
});

function switchTab(tab) {
    if (!tab) return;
    
    // Remove active class from all tabs and content
    document.querySelectorAll('.response-tabs .tab').forEach(t => {
        if (t && t.classList) {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
        }
    });
    document.querySelectorAll('.tab-content').forEach(c => {
        if (c && c.classList) {
            c.classList.remove('active');
        }
    });

    // Add active class to clicked tab and its content
    if (tab.classList) {
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');
    }
    const contentId = tab.getAttribute('aria-controls');
    const contentElement = document.getElementById(contentId);
    if (contentElement && contentElement.classList) {
        contentElement.classList.add('active');
    }
}

function copyResponse() {
    const responseBody = document.getElementById('modalResponseBody');
    if (!responseBody) return;
    
    const responseText = responseBody.textContent;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(responseText).then(() => {
            showToast('Response copied to clipboard');
        }).catch(() => {
            showToast('Failed to copy response');
        });
    } else {
        showToast('Clipboard not supported');
    }
}

function downloadResponse() {
    const responseBody = document.getElementById('modalResponseBody');
    if (!responseBody) return;
    
    const responseText = responseBody.textContent;
    const blob = new Blob([responseText], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'response.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Response downloaded');
}

function formatResponse() {
    try {
        const responseBody = document.getElementById('modalResponseBody');
        if (!responseBody) return;
        
        const content = responseBody.textContent;
        if (!content.trim()) return;
        
        try {
            const parsed = JSON.parse(content);
            responseBody.textContent = JSON.stringify(parsed, null, 2);
        } catch (e) {
            // If not JSON, just return as is
            console.log('Response is not valid JSON, skipping formatting');
        }
    } catch (error) {
        console.error('Error formatting response:', error);
    }
}

function collapseAll() {
    const responseBody = document.getElementById('modalResponseBody');
    if (!responseBody) return;
    
    // Simple collapse - replace newlines with spaces for basic collapse
    const content = responseBody.textContent;
    if (content) {
        responseBody.textContent = content.replace(/\n\s*/g, ' ').trim();
    }
}

function expandAll() {
    const responseBody = document.getElementById('modalResponseBody');
    if (!responseBody) return;
    
    const content = responseBody.textContent;
    if (!content.trim()) return;
    
    try {
        // Try to format as JSON first
        const parsed = JSON.parse(content);
        responseBody.textContent = JSON.stringify(parsed, null, 2);
    } catch (e) {
        // If not JSON, just restore original formatting
        responseBody.textContent = content;
    }
}

function showToast(message) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #333;
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        z-index: 10000;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    // Show toast
    setTimeout(() => {
        toast.style.opacity = '1';
    }, 10);
    
    // Hide toast after 3 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

function initializePrism() {
    // Basic syntax highlighting placeholder
    // This would integrate with Prism.js if available
    console.log('Syntax highlighting initialized');
}

</script>